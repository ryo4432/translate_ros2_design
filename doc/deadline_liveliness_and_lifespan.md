元の文書  
https://design.ros2.org/articles/qos_deadline_liveliness_lifespan.html

# ROS QoS Deadline, Liveliness, Lifespan

この記事はROSへのQoS設定の記事に，Deadline, Liveliness, Lifespanを加えたものです。要求の概要を述べ，既存コードベースへ統合される方法について述べます。

#### 用語

- DDS: Data Distribtuion Service
- RTPS: Real Time Publish Subscribe
- QoS: Quality of Service
- Service Client: 単にクライアントとも呼びます。ROSのサービスに対してリクエストを送信し，レスポンスを受信するアプリケーションのことを指します。
- Service Server: 単にサーバーとも呼びます。リクエストを受信し，レスポンスを送信するようなROSサービスの駆動しているアプリケーションのことを指します。

## 既存のROSのQoS設定

　DDSは，任意の存在に対してQoSを通したきめ細かな制御を可能にするために，多くの設定を提供する一方で，ROSはそれらを扱いやすくするためのサポートを提供するだけです。ROSユーザーはパブリッシャーやサブスクライバなどを生成するときに，History, Depth, ReliabilityおよびDurabilityをQoS設定用構造体に指定することができます。  
　これは，もしDDSベンダーが構成ファイルを介してあらたに追加されたデフォルトの設定を読み込むことができるようになっていれば，(QoS設定はその構成ファイルからでしか設定できないので)多くのQoS設定をそのまま維持できます。もし，あるユーザーが追加のQoS設定を自身のコードに使いたい場合，ベンダー固有のAPIに対してRMW実装やプログラムへの参照を取得する必要があります。ROSによって提供される抽象レイヤーがないと，コードの移植性が低下します。

## 新たなQoS設定

　ユーザーはよりロバストなアプリケーションを構築していくので，データが受信できた時や，システムが落ちている時の情報であっても，より多くの制御を必要とするようになります。これらの需要に対処するために，我々は以下の新しいDDS QoS設定をサポートすることとしました。

### Deadline(期限)

　Deadlineポリシーは，メッセージの通信間隔に関して規定します。サブスクライバーでは，メッセージの受信間隔の最大時間を設定します。パブリッシャーでは，メッセージ送信間隔の最大時間を設定します。トピックはRMWまでのレイヤーのみでDeadline追跡をサポートします。これは，RMWレイヤーが指定時間内にメッセージを受信しなかったら，Deadlineの設定を遵守できなかったものとみなされることを意味します。サブスクライバーがパブリッシャーのトピックを受信するためには，サブスクライバーが要求するDeadlineの設定はパブリッシャーが設定したDeadline設定よりも大きいか同じになるようにしなければなりません。Deadline時間を0にすると，Deadline追跡を無効にします。デフォルトのDeadline時間は0としています。

### Liveliness(生存性)

　Livelinessポリシーは，ノードの生き死を伝える方法に関して規定します。サブスクライバーでは，サブスクライブ先のパブリッシャーに必要な通知レベルを規定します。パブリッシャーでは，生存していることをサブスクライバーに提供する通知レベルを規定します。トピックは以下のLivelinessのレベルをサポートします。

- LIVELINESS_SYSTEM_DEFAULT：ROSのデフォルトで指定されているLiveliness設定を使用します(これはLIVELINESS_AUTOMATICです)。
- LIVELINESS_AUTOMATIC：トピックが生存していることを規定する信号が，ROSのRMWレイヤーからきます。
- LIVELINESS_MANUAL_BY_NODE：トピックが生きていることを規定する信号はノードレベルであることを意味します。  
ノードの発信チャンネルでメッセージをパブリッシュするか，ノードの生存をアサートするためのアプリケーションから明確な信号を発すると，ノード上にあるすべての発信しているチャンネルが生きているものとしてマークされます。
- LIVELINESS_MANUAL_BY_TOPIC：トピックが生きていることを示す信号はトピックレベルであることを意味します。トピックでメッセージをパブリッシュするか，トピックの生存をアサートするアプリケーションからの明確な信号を発すると，トピックが生存しているものとしてマークされます。

サブスクライバーがパブリッシャのトピックを受信するためには，サブスクライバーが要求するLiveliness追跡のレベルが，パブリッシャーから提供されている追跡レベルよりも同じか，それ以下の冗長性でなければならず，サブスクライバーによって設定される，生存していないと判断されてしまうまでの時間は，パブリッシャーによって設定された時間よりも長くなければなりません。

### Lifespan(生存期間)

　Lifespanポリシーはメッセージの有効期限について規定します。サブスクライバーでは，メッセージが有効である時間の長さを規定し，その時間の経過後，メッセージは受信されません。パブリッシャーでは，メッセージが有効である時間の長さを規定し，その時間経過後，トピックの履歴から取り除かれ，サブスクライバーヘは送信されなくなります。Lifespanが0の時は，Lifespanの追跡が無効になります。デフォルトのLifespanは0に設定されています。

### DDSとQoSの関係

　これらの新しいポリシーは，すべてDDSのQoSポリシーに基づいていますが，DDSへは，RMWの実装がこれらをサポートすることを要求していません。これらのポリシーのDDSの特長に関するより詳細な情報は，末節の付録Aに記載されています。

### ROSの変更

　DeadlineやLivelinessを標準サポートするために，ROSには様々な変更がなされました。

#### リソース状態のイベントハンドラ

　DeadlineとLivelinessのどちらもが，アプリケーションが通知する必要のあるRMWレイヤーからのイベントを生成します。Deadlineの場合，サブスクライバーでは期限内に何もメッセージを受信しなかったらイベント通知を受け取り，パブリッシャーでは期限内何もパブリッシュしなかったらイベント通知を受け取ります。Livelinessの場合，サブスクライバーはトピックが生存していることをアサートする生存中のパブリッシャーがなくなったときにイベント通知を受け取ります。サービスはクライアントとサーバーが定義済みポリシーに反した時に似たイベントを生成します。これらのどちらも，「リソース状態のイベント」のカテゴリーの元にあります。

　これらの通知を取り扱うために，新たなコールバック関数がユーザーによって提供されます。このコールバック関数とは，特定のトピックに関していつでもイベントを発行します。